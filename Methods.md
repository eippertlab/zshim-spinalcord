## 2.4 Selection of slice-specific z-shim moments

### 2.4.2 Automated selection

#### [2.4.2.1 EPI-based selection](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/EPI_based/ZShimOnlineCalculation_EPIbased.m)
In a subsample of 24 participants, the EPI z-shim reference-scan was used to determine the optimum z-shim moments. [The EPI z-shim reference-scan – consisting of 21 volumes (each volume corresponding to one z-shim moment) with 24 slices each – was then averaged over the 21 volumes, i.e. over all z-shim moments](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/EPI_based/ZShimOnlineCalculation_EPIbased.m#L85) and [the resulting mean image was automatically segmented using the PropSeg approach implemented in SCT](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/EPI_based/ZShimOnlineCalculation_EPIbased.m#L86) (De Leener et al., 2014). Based on experience from pilot experiments, we built in several fail-safes [(i.e. systematically changing the arguments of SCT’s PropSeg function that affect the propagation in the z-direction)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/EPI_based/ZShimOnlineCalculation_EPIbased.m#L93-L139) in order to ensure that the segmentation would propagate across the entire slice stack; this possibility to automatically adjust parameters in case of failure was also the reason that – out of SCT’s segmentation algorithms – we chose PropSeg instead of DeepSeg. We used the mean image for segmentation because we wanted to ensure that image quality was sufficient for automatic segmentation of the spinal cord and because the averaging of volumes acquired during different breathing cycles avoids a bias towards one respiratory state as could occur with single volumes.

#### 2.4.2.2 	[Field map (FM) based selection](https://github.com/eippertlab/zshim-spinalcord/tree/main/ZShim_OnlineCalculation/FM_based)
In another subsample of 24 participants, sagittal field maps (acquired with the same angulation as EPI data) were used to determine the optimum z-shim moments; note that field maps had anisotropic voxels, as i) a high in-plane resolution of the sagittal field map is necessary in order to obtain sufficient information about the gradient in the trough-slice direction of the EPI (i.e. foot-head) and ii) the left-right direction (where voxels were largest) is expected to have the least field variation and is thus least sensitive to resolution. First, [a spinal cord mask was generated via a PropSeg-based automatic segmentation of each participant’s T2-weighted image](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/FM_based/ZShimOnlineCalculation_FMbased.m#L98) because a high-quality segmentation of the field map magnitude image was not possible due to the sagittal slice thickness of 2.2mm as well as the  poor image contrast between spinal cord and cerebrospinal fluid (note that since [the T2-weighted image and field map were well aligned and acquired right after each other we did not carry out a separate registration step](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/FM_based/ZShimOnlineCalculation_FMbased.m#L108-109). [Field map based (from now on referred to as FM-based) z-shim moments were then calculated for each EPI slice using a linear least-squares fit of a set of spatial basis functions to the measured field map ](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/FM_based/ZShimOnlineCalculation_FMbased.m#L121-L141) [(which was smoothed with an isotropic 1mm Gaussian kernel prior to the calculation)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/FM_based/ZShimOnlineCalculation_FMbased.m#L114). [The spatial basis functions consisted of three linear field terms along the main imaging axes and a spatially homogenous field term, representing a field offset (although obtaining x- and y-gradients is not necessary for calculating the through-slice field component, their inclusion can be seen as a step towards full slice-wise shimming [see also Islam et al., 2019] and obtaining y-gradients is necessary for determining the effective TE [see below]). Only voxels within the spinal cord mask contributed to the fitting procedure, which included voxels within a 9 mm thick slab (i.e. 9 transversal field map slices) centered on the center of the corresponding EPI slice. The slab was chosen to be thicker than the EPI slice (i.e. addition of 2mm on each side of the EPI slice) in order to give more robust estimates of the through-slice field gradient.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/FM_based/ZShimOnlineCalculation_FMbased.m#L121-L141) [The fitted through-slice linear field term (G_z) was taken to represent the local field gradient causing through-slice signal dephasing within the corresponding EPI slice](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/FM_based/ZShimOnlineCalculation_FMbased.m#L145). [The resulting dephasing gradient moment of G_z∙TE was rounded to the nearest of the 21 z-shim compensations available in the EPI protocol and then used for subsequent EPI acquisitions.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_OnlineCalculation/FM_based/ZShimOnlineCalculation_FMbased.m#L148-L155) The average time for the execution of the selection code was 36.1 seconds (range across the entire sample: 31.5- 53.3 seconds).




## [2.5 Preprocessing](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m)


### 2.5.1 Motion-correction of EPI time-series data
A two-step motion correction procedure (with spline interpolation) was applied to the EPI time-series data. Initially, the mean of 750 volumes (250 volumes under each of the three different conditions, i.e. no z-shim | manual z-shim | automated z-shim) was calculated in order to serve as the target image for the first step of motion correction; averaging across all three conditions eliminates a bias towards any one condition with respect to the target image. Based on this mean image, the spinal cord was automatically segmented in order to provide a spinal cord centerline that then served as input for creating a cylindrical mask (with a diameter of 30mm). This mask was employed during the motion-correction procedure in order to ensure that image regions moving independently from the cord would not adversely affect motion estimation. Slice-wise motion correction with a 2nd degree polynomial regularization in the z-direction was then performed (De Leener et al., 2017). In the second step, a new target image was obtained by calculating the mean of motion-corrected images from the first step and the raw images were realigned to this new target image, using the identical procedure as described above. [Please note that the data obtained under different TEs (25 images per TE and condition) were also registered to this target image using the same procedure.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L63-67)

### 2.5.2 Segmentation
[T2-weighted images were initially segmented using the DeepSeg approach implemented in SCT](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L185) (Gros et al., 2019). [This initial segmentation was used for smoothing the cord along its centerline using an anisotropic kernel with 8mm sigma.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L186) [The smoothed image was again segmented in order to improve the robustness of segmentation.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L187)


### 2.5.3 Registration to template space

The T2-weighted image of each participant was brought into template space using three consecutive registration steps: i) using the spinal cord segmentation, the spinal cord was straightened, ii) [the automatically determined labels of vertebrae between C2-C7 (manually corrected where necessary)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L240-L248) were used for vertebral alignment between the template and the individual T2-weighted image, and iii) [the T2-weighted image was registered to the template using non-rigid segmentation-based transformations.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L250-L256)


In order to bring the functional images to template space, [the template was registered to the functional images using non-rigid transformations (with the initial step using the inverse warping field obtained from the registration of the T2-weighted image to the template image).](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L286-L291) [The resulting inverse warping fields obtained from this registration (from native EPI space to template space) were then applied to the respective functional images (e.g. single EPI volumes, mean EPI volume, tSNR maps) to bring them into template space where statistical analyses were carried out.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L275-L304)

Finally, we also brought each participant’s field map into template space in order to visualize the average B0 field variation across participants. [Each participant’s field map was first resampled to the resolution of the T2-weighted image before the warping field obtained from the registration to template space was applied to the field map.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L402-L427)


### 2.5.4 EPI signal extraction

In order to assess the effects of z-shimming, we obtained signal intensity data from each EPI slice. [When analyses were carried out in native space and were based on the entire spinal cord cross-section, we used the above-mentioned hand-drawn masks of the spinal cord and obtained one value per slice (average across the entire slice)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L488-L498). [In contrast, when analyses were carried out in template space or were based on gray matter regions only, we made use of the available PAM50 template masks of the entire spinal cord or the gray matter (with the probabilistic gray matter masks thresholded at 90%); again, we obtained one average value per mask and slice](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step1_Preprocessing/ZShim_Preprocessing_II_V.m#L429-L478). Please note that in addition to reporting p-values from statistical tests, we also report (where adequate) the percentage difference between conditions and the associated 95% confidence interval (CI) as estimated via bootstrapping.

## [2.6 Statistical analysis](https://github.com/eippertlab/zshim-spinalcord/tree/main/ZShim_Results/Step2_CalculateResults)
### [2.6.1 Replication and extension of previous findings](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m)
#### 2.6.1.1 Direct replication
In a first set of analyses (across all 48 participants), we aimed to replicate the findings of Finsterbusch et al. (2012). [We, therefore, used template space single-volume EPI data acquired under no z-shim and manual z-shim conditions, calculated the individual EPI signal intensity per slice and reported the mean of signal intensity across all slices as well as the variation of signal intensity across all slices; for the latter, we initially used the variance (as done by Finsterbusch et al., 2012), but after the replication of their results we employed the coefficient of variation for the remainder of the manuscript (due to it being a standardized measure of variability). Both descriptive changes (percent increase / decrease) , as well as statistical values (based on paired t-tests), were reported for the condition comparison.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L29-L32) To additionally investigate how robust these findings were, we complemented these single-volume analyses – that might be affected by various noise sources – by the same analysis approach, [but now carried out on an EPI volume that is the average of a time-series of 250 motion-corrected EPI volumes (acquired both for no z-shim and manual z-shim; Supplementary Material)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L34-L39). In order to demonstrate that neither of these results were impacted by registration to template space, [we also reported native space results in the Supplementary Material(acquired both for no z-shim and manual z-shim; Supplementary Material)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L41-L45).

#### 2.6.1.2 Slice-by-slice characterization of z-shim effects
Finsterbusch et al. (2012) already demonstrated that the improvement due to slice-specific z-shimming varies spatially along the rostro-caudal direction. We therefore reasoned that it might be informative to also quantify the benefit for slices with various degrees of signal-loss (obviously, such an analysis could only be carried out in native space). [We first did this in a descriptive manner by reporting i) the maximally found percentage increase in signal intensity due to z-shimming and ii) the proportion of slices that differed by 0, 1, 2, 3, and >3 z-shim steps from the ‘neutral’ setting of no z-shim.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L52-L97) [In the Supplementary Material, we then followed this up more formally with an analysis where we categorized slices according to the manually chosen z-shim value and compared the signal intensity in these categories between no z-shim and manual z-shim both descriptively (using % signal intensity difference) and inferentially using a 2×5 repeated-measures ANOVA (factor 1: condition with two levels: no z-shim, manual z-shim; factor 2: step-difference with five levels: 0, 1, 2, 3, >3). We tested for a main effect of condition, a main effect of step-difference and an interaction between these two factors; post-hoc t-tests were Bonferroni corrected](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L99-L109). To estimate the robustness of the results from these analyses (which were based on single EPI volumes), [we repeated them on the average across the 250 motion-corrected EPI volumes (Supplementary Material)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L111-L167).

#### 2.6.1.3 z-shim effects across different TEs
We also aimed to assess the effects of z-shimming at TEs clearly shorter (30ms; fastest TE possible with the employed partial-Fourier factor of 7/8) and longer (50sm; same distance to our standard TE of 40ms) than the estimated T2* in the cervical spinal cord at 3T (~40ms; Barry et al., 2019), considering that such choices might often be necessary in fMRI studies (see also Discussion). [We, therefore, repeated the analyses described in section 2.6.1.1 (assessing the mean of signal intensity across all slices as well as the variation of signal intensity across all slices for no z-shim and manual z-shim conditions) on the template-space EPI data obtained with TEs of 30ms and 50ms, both for single-volume data](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L169-179) and [(in the Supplementary Material) for an average of the 25 volumes acquired at each of the different TEs](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L181-193).

#### 2.6.1.4 z-shim effects in gray matter regions
The effects reported in Finsterbusch et al. (2012) were obtained from averages across the entire cross-section of the spinal cord, thus mixing gray and white matter signals. However, with the availability of probabilistic gray matter maps (via SCT, see https://github.com/spinalcordtoolbox/PAM50; De Leener et al., 2017) it is now possible to investigate whether the signal-drop outs and their mitigation via z-shimming are also present in the gray matter (which is the relevant tissue for fMRI) and might even vary spatially (i.e. between dorsal and ventral horns). [In order to address these two questions, we ran a 2×2 repeated-measures ANOVA (factor 1: condition with two levels: no z-shim, manual z-shim; factor 2: anatomical location: dorsal horn, ventral horn) where we tested for a main effect of condition, a main effect of location and an interaction between the two factors (Supplementary Material)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L222-L252); [this was followed up by post-hoc Bonferroni-corrected t-tests (where we also report % increase for the direct comparisons)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L195-L219). [As underlying metrics, we tested both the mean of signal intensity across all slices and the variation of signal intensity across slices. To assess robustness, the above-described analyses (based on single-volume EPIs) were repeated based on the average across the 250 motion-corrected volumes](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L276-L310). [As a negative control, we also performed the same analyses as above, but now splitting the spinal cord gray matter into left and right parts](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L254-274).

#### 2.6.1.5 z-shim effects on time-series data
The analyses described above, as well as the results reported by Finsterbusch et al. (2012) were solely based on measures of signal intensity. In order to directly investigate the potential benefit of z-shimming for spinal cord fMRI, we also investigated its effect on the temporal signal-to-noise ratio (tSNR, i.e. temporal mean divided by temporal standard deviation on a voxel-by-voxel basis) of motion-corrected data (250 volumes). We are aware that effects on tSNR do not allow for a perfect one-to-one extrapolation to effects on BOLD responses, but we nevertheless believe this to be an adequate proxy measure due to the following reasoning (Deichmann et al., 2002; De Panfilis & Schwarzbauer, 2005; Poser et al., 2006): since the contrast-to-noise ratio (CNR) of BOLD responses is proportional to the product of the effective TE and tSNR and the effective TE does not depend on the magnetic field gradient in the z-direction, any tSNR gain obtained by z-shimming should reflect a corresponding gain in BOLD-CNR in arbitrary task-based fMRI studies.
[Following up on section 2.6.1.4, we only assessed this in the region most relevant for fMRI, i.e. the gray matter of the spinal cord. We compared mean tSNR across all slices, as well as variation of tSNR across slices, between no z-shim and manual z-shim conditions: we descriptively reported % increase and also tested for significant differences using paired t-tests](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L313-L346).
Since there was a possibility that the signal loss occurring in the lowermost slices in the no z-shimming condition could negatively impact the motion correction that was employed in the current study (as this is regularized along z using a 2nd-degree polynomial), [we performed the above-mentioned analyses also after “censoring” of outlier volumes (Supplementary Material; see also section 2.5.1)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_I.m#L348-L356).

### [2.6.2 Automating slice-specific z-shimming](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m)
#### 2.6.2.1 EPI-based automation
Next, we investigated the performance of the EPI-based automated approach for selecting z-shim values, both in comparison to the conditions of no z-shim and manual z-shim; this was carried out in a sub-group of 24 participants. For the sake of brevity, we [i) only reported our effects of interest – signal intensity based on single EPI volumes (Supplementary Material)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L61-L71) and [tSNR based on EPI time-series – in the spinal cord gray matter (i.e. ignoring whole-cord data)](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L50-L59) and ii) employed direct comparisons of conditions without using an initial omnibus test. [Thus, in this sub-group of 24 participants we investigated:  i) no z-shim vs manual z-shim, ii) no z-shim vs auto z-shim, and iii) manual z-shim vs auto z-shim. We reported % differences, as well as Bonferroni-corrected p-values from paired t-tests, again using mean and variation metrics.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L50-L59)

#### 2.6.2.2 FM-based automation
We investigated the performance of the FM-based automated approach for selecting z-shim values (based on a different sub-group of 24 participants) using the [identical procedure as outlined in the previous paragraph](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L73-L95).
However, since we discovered that the performance of the FM-based approach was slightly inferior compared to the manual approach, we followed this up with several post-hoc investigations (detailed in the Supplementary Material). Briefly, we first used the vendor-based field map and assessed the contributions of i) [the choice of mask for identifying the spinal cord in the field map phase data](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L121-L125), ii) [various choices of parameters employed in the fitting process of the gradient field](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L127-L132), iii) [field-gradients in the AP-direction](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L134-L137), and iv) [inhomogeneity-induced mis-localizations between EPIs and field map](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L139-L140). [Second, we substituted the vendor-based field map by the more robust in-house field map and compared their performance](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L142-L146). [Third, we assessed the general reliability of estimating z-shim values from field map data by repeating the fitting process on a second in-house field map that was acquired at the end of the experiment](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L148-L152). [Finally, we used a different (histogram-based) approach to calculate the z-shim values from field map data.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/Helper_Code/ZShim_SuppIII_II_II_VII_HistogramEvaluation/EvalzShimsFromB0.pro) [Importantly, only the histogram-based evaluation led to a consistent improvement in performance, although even this method still did not achieve the performance of manual selection.](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/ZShimResults_III_II.m#L154-L159)

#### [2.6.2.3 Comparing all three approaches](https://github.com/eippertlab/zshim-spinalcord/blob/main/ZShim_Results/Step2_CalculateResults/Helper_Code/ZShim_CompareThreeApproaches.m)

First, we used two-sample t-tests (with Bonferroni-corrected two-tailed p-values) in order to assess the following: i) comparing the baselines of no z-shim between the two groups, ii) comparing the improvement of manual z-shim vs no z-shim between the two groups, iii) comparing the improvement of auto z-shim vs no z-shim between the two groups and iv) comparing the difference of manual z-shim vs auto z-shim between the two groups. This was carried out based on gray matter tSNR from EPI time-series, using both the mean as well as the variation of tSNR across all slices. In complementary analyses, we also assessed the similarity between the automated approaches and the manual approach in terms of the actually chosen z-shim step using rank-based correlation and Euclidean distance (Supplementary Material).
Second, we assessed the stability of z-shim effects (based on either of the automated approaches as well as the manual approach) over time in all 48 participants. We were able to do this since we acquired an EPI reference-scan not only at the beginning of the experiment, but also at the end (~60 minutes later). Using these reference scans, we ‘artificially reconstructed’ an EPI volume from each of the reference scans by selecting the corresponding volume for each slice based on the chosen z-shim values, no matter whether a participant was in the EPI-based or FM-based automation group. Importantly, we chose the ‘originally’ determined z-shim values to reconstruct ‘artificial volumes’ from both the first and the second reference scan. These volumes were then realigned to the mean of the motion-corrected time series. The warping fields that were obtained during the normalization of motion-corrected mean image to the template space were used to bring these volumes to the template space. We then compared gray matter signal characteristics (mean and variation of signal intensity across slices, respectively) for both time-points using the various conditions via paired t-tests with Bonferroni-correction.
